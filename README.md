# Import Module

Модуль **Import** предназначен для импорта различных сущностей (категории, продукты, бренды и т.д.) из внешнего
источника в систему с использованием событий, очередей и фасадов необходимой бизнес-логики.

---

## Основные возможности:

- **Гибкий процесс импорта.** Модуль поддерживает работу с различными типами сущностей, которые можно легко добавить
  через конфигурацию.
- **Событийная модель.** Для каждой сущности возбуждаются события, что позволяет выполнять дополнительную обработку
  данных до отправки в очередь.
- **Поддержка очередей.** Импортируемые данные обрабатываются асинхронно в задачах на очередях.
- **Консольные команды.** Команда `php artisan import` позволяет запускать процесс импорта напрямую из консоли.
- **Расширяемость.** Легко добавляйте новые сущности и процессы импорта благодаря использованию интерфейсов и
  конфигураций.
- **Обработка ошибок.** Логируются все ошибки, связанные с API и валидацией данных, с помощью исключений.

---

## Конфигурация

Импортируемые сущности указываются в конфигурационном файле `config/import.php`.
Пример содержания:

```php
return [
    'website_config' => [
        'url' => env('WEBSITE_IMPORT_URL'), // URL внешнего API
        'key' => env('WEBSITE_IMPORT_KEY'), // Ключ авторизации
    ],

    'import_entities' => [
        'categories' => [
            'dto' => CategoryResponseDto::class, // Трансфер данных
            'endpoint' => 'categories',          // Endpoint API
            'event' => CategoryImportEvent::class, // Событие
        ],
    ],
];
```

---

## Как использовать

### Консольная команда импорта

Для запуска процесса импорта используйте:

```bash
php artisan import
```

**Пошагово:**

1. Команда запросит название сущности, например, `categories` (категории).
2. Уточните лимит записей, которые вы хотите импортировать.
3. Задайте номер страницы для обработки.

---

### Внешний сервис: структура запросов и ответов

Получение данных происходит через HTTP-запросы к API. Настройки URL и API-ключа конфигурируются в `config/import.php` (
см. выше).

**Пример обращения к API через `WebsiteReceiver`:**

1. Отправляется POST-запрос с параметрами:
    - `endpoint` - API-ресурс.
    - `limit` - количество записей.
    - `page` - номер страницы.
    - А также заголовки авторизации.
2. Ответ возвращается в JSON-формате и преобразуется в коллекции DTO-сущностей.

___

### Настройка внешнего сервиса

Конфигурация импорта хранится в файле `config/services.php`. Для корректной работы необходимо указать:

- URL сервиса импорта.
- Ключ авторизации.

Пример:

```php
'website_import' => [
    'url' => env('WEBSITE_IMPORT_URL'),
    'key' => env('WEBSITE_IMPORT_KEY'),
],
```

## Архитектура модуля

### 1. **WebsiteReceiver**

Работа с внешними API запросами через HTTP-клиенты:

- Формирует запрос на основании DTO.
- Логирует ошибки и выбрасывает исключения: `ImportResponseException`.

Методы:

```php
public function receive(ImportRequestDto $requestDto): Collection
```

---

### 2. **EntityImportConnector**

Служит универсальным обработчиком импорта:

- Получает поток данных через API (постранично), используя метод `stream`.
- Связывает DTO, события и задачи очереди.

Пример использования:

```php
$connector->stream(new ImportRequestDto(...));
```

---

### 3. **DTO (CategoryResponseDto)**

`DTO` позволяет трансформировать полученные данные в понятный объект. Для корректной работы ваш `DTO` должен
реализовывать интерфейс `ResponseDtoInterface`, который предоставляет метод `fromResponse`.
Например:

```php
$data = [
    'id' => 1,
    'name' => 'Категория',
    'isActive' => true,
];

$dto = CategoryResponseDto::fromResponse($data);
echo $dto->name;
```

---

### 4. **Events**

События используются для уведомления системы о начале обработки данных:

```php
CategoryImportEvent::dispatch($data);
```

---

### 5. **Jobs**

Для каждой сущности запускается отдельная задача обработки через очередь:

```php
CategoryImportJob::dispatch($categoryCollection);
```

---

## Добавление новой сущности

Для подключения новой сущности:

1. Создайте DTO для обработки данных (например, `ProductResponseDto`).
2. Добавьте событие для сущности (например, `ProductImportEvent`).
3. Реализуйте задачу, которая будет обрабатывать данные (`ProductImportJob`).
4. Укажите новую сущность в конфигурации:

```php
'import_entities' => [
    'products' => [
        'dto' => ProductResponseDto::class,
        'endpoint' => 'products',
        'event' => ProductImportEvent::class,
    ],
],
```

---

## Требования

- PHP 8.3+
- Laravel 10.0+
- Пакет **Spatie Laravel Data** для работы с DTO.

---

## Лицензия

Проект доступен на условиях лицензии MIT.
